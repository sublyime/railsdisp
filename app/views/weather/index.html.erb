<%# Weather Data Index Page %>
<% content_for :title, "Weather Monitoring" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-cloud-sun text-primary"></i> Weather Monitoring</h2>
        
        <div class="btn-group">
          <%= link_to weather_update_all_path, method: :post, 
                      class: "btn btn-primary btn-sm",
                      data: { confirm: "Update weather for all locations?" } do %>
            <i class="fas fa-sync"></i> Update All
          <% end %>
          
          <%= link_to new_weather_datum_path, class: "btn btn-success btn-sm" do %>
            <i class="fas fa-plus"></i> Add Manual Entry
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Current Weather Summary -->
    <div class="col-md-3">
      <div class="card mb-4">
        <div class="card-header">
          <h5><i class="fas fa-thermometer-half"></i> Current Conditions</h5>
        </div>
        <div class="card-body">
          <% if @weather_data.any? %>
            <% latest = @weather_data.first %>
            <div class="text-center">
              <h3 class="text-primary"><%= latest.temperature %>째C</h3>
              <p class="mb-1">
                <i class="fas fa-wind"></i> <%= latest.wind_speed %> m/s 
                <small class="text-muted">(<%= latest.wind_direction %>째)</small>
              </p>
              <p class="mb-1">
                <i class="fas fa-eye"></i> <%= latest.humidity %>% humidity
              </p>
              <p class="mb-1">
                <span class="badge bg-info"><%= latest.stability_class %></span>
                <small class="text-muted">Stability</small>
              </p>
              <small class="text-muted">
                Updated <%= time_ago_in_words(latest.recorded_at) %> ago
              </small>
            </div>
          <% else %>
            <p class="text-muted text-center">No weather data available</p>
          <% end %>
        </div>
      </div>

      <!-- Weather Alerts -->
      <div class="card mb-4">
        <div class="card-header">
          <h6><i class="fas fa-exclamation-triangle"></i> Weather Alerts</h6>
        </div>
        <div class="card-body">
          <% high_wind_locations = @weather_data.select { |w| w.wind_speed > 15 } %>
          <% if high_wind_locations.any? %>
            <div class="alert alert-warning alert-sm">
              <strong>High Winds:</strong> <%= high_wind_locations.count %> location(s)
            </div>
          <% end %>
          
          <% low_visibility = @weather_data.select { |w| w.visibility < 5 } %>
          <% if low_visibility.any? %>
            <div class="alert alert-danger alert-sm">
              <strong>Low Visibility:</strong> <%= low_visibility.count %> location(s)
            </div>
          <% end %>
          
          <% if high_wind_locations.empty? && low_visibility.empty? %>
            <p class="text-success text-center mb-0">
              <i class="fas fa-check-circle"></i> No weather alerts
            </p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Weather Data Table -->
    <div class="col-md-9">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-table"></i> Weather Data</h5>
          
          <div class="input-group" style="width: 300px;">
            <input type="text" class="form-control form-control-sm" 
                   id="weatherSearch" placeholder="Search locations...">
            <button class="btn btn-outline-secondary btn-sm" type="button">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
        
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0" id="weatherTable">
              <thead class="table-dark">
                <tr>
                  <th>Location</th>
                  <th>Temperature</th>
                  <th>Wind</th>
                  <th>Humidity</th>
                  <th>Pressure</th>
                  <th>Stability</th>
                  <th>Recorded</th>
                  <th>Source</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @weather_data.each do |weather| %>
                  <tr data-location="<%= weather.latitude %>,<%= weather.longitude %>">
                    <td>
                      <strong><%= weather.latitude.round(4) %>, <%= weather.longitude.round(4) %></strong>
                      <br>
                      <small class="text-muted">Elev: <%= weather.try(:elevation) || 'N/A' %>m</small>
                    </td>
                    
                    <td>
                      <span class="badge bg-<%= temperature_color(weather.temperature) %>">
                        <%= weather.temperature %>째C
                      </span>
                    </td>
                    
                    <td>
                      <div>
                        <i class="fas fa-wind"></i> <%= weather.wind_speed %> m/s
                        <br>
                        <small class="text-muted">
                          <%= weather.wind_direction %>째 
                          (<%= wind_direction_text(weather.wind_direction) %>)
                        </small>
                      </div>
                    </td>
                    
                    <td><%= weather.humidity %>%</td>
                    
                    <td><%= weather.pressure %> hPa</td>
                    
                    <td>
                      <span class="badge bg-info"><%= weather.stability_class %></span>
                      <br>
                      <small class="text-muted">
                        <%= stability_description(weather.stability_class) %>
                      </small>
                    </td>
                    
                    <td>
                      <%= weather.recorded_at.strftime("%H:%M") %>
                      <br>
                      <small class="text-muted">
                        <%= time_ago_in_words(weather.recorded_at) %> ago
                      </small>
                    </td>
                    
                    <td>
                      <span class="badge bg-secondary"><%= weather.source %></span>
                    </td>
                    
                    <td>
                      <div class="btn-group btn-group-sm">
                        <%= link_to weather, class: "btn btn-outline-primary btn-sm" do %>
                          <i class="fas fa-eye"></i>
                        <% end %>
                        
                        <%= link_to edit_weather_datum_path(weather), 
                                    class: "btn btn-outline-secondary btn-sm" do %>
                          <i class="fas fa-edit"></i>
                        <% end %>
                        
                        <%= link_to weather_update_location_path(location_id: weather.id), 
                                    method: :post,
                                    class: "btn btn-outline-success btn-sm",
                                    data: { confirm: "Update weather for this location?" } do %>
                          <i class="fas fa-sync"></i>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
            
            <% if @weather_data.empty? %>
              <div class="text-center p-5">
                <i class="fas fa-cloud-meatball fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Weather Data</h5>
                <p class="text-muted">Click "Update All" to fetch current weather conditions.</p>
                <%= link_to weather_update_all_path, method: :post, 
                            class: "btn btn-primary" do %>
                  <i class="fas fa-sync"></i> Fetch Weather Data
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Real-time weather updates
document.addEventListener('DOMContentLoaded', function() {
  // Search functionality
  const searchInput = document.getElementById('weatherSearch');
  const table = document.getElementById('weatherTable');
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const filter = this.value.toLowerCase();
      const rows = table.querySelectorAll('tbody tr');
      
      rows.forEach(row => {
        const location = row.dataset.location;
        const visible = location.toLowerCase().includes(filter);
        row.style.display = visible ? '' : 'none';
      });
    });
  }
  
  // Auto-refresh weather data every 60 seconds
  setInterval(function() {
    if (document.querySelector('[data-auto-refresh="true"]')) {
      window.location.reload();
    }
  }, 60000);
});

// Weather data filtering
function filterByStability(stabilityClass) {
  const rows = document.querySelectorAll('#weatherTable tbody tr');
  rows.forEach(row => {
    const stability = row.querySelector('.badge').textContent;
    row.style.display = (stabilityClass === 'all' || stability === stabilityClass) ? '' : 'none';
  });
}
</script>